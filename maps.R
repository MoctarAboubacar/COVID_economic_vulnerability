# map
# ## import shape file and load index data into it
# shp <- st_read("C:/Users/moctar.aboubacar/Desktop/Vul Index/Nepal vulnerability shapefile/combined_data_sae_popn_building_vul_caste.shp")
# 
# shp <- merge(shp, df_index[c("HLCIT_CODE", "Geo_Code", "Population2020", "Index_add", "Index_add_quint", "Index_geo", "Index_geo_quint", "Exposure", "Exposure_quint", "Sensitivity", "Sensitivity_quint","AdaptiveCapacity", "AdaptiveCapacity_quint")], all.x = TRUE)

# new shape file
shp <- st_read("C:/Users/moctar.aboubacar/Desktop/Covid vulnerability index/Nepal_Palikawise_Boundary_WGS/nepal_new_str_wgs_84.shp")

shp <- merge(shp, df_index[c("Geo_Code", "Population2020", "Index_add", "Index_add_quint", "Index_geo", "Index_geo_quint", "Exposure", "Exposure_quint", "Sensitivity", "Sensitivity_quint","AdaptiveCapacity", "AdaptiveCapacity_quint")], all.x = TRUE)



##### addressing missing data issue- 4 palikas in Sarlahi...the issue happens when merging based on the HLCIT code I'm pretty sure... should I be using the GCode?
df_missing <- shp %>% 
  filter(is.na(Index_geo),
         LU_Type != "National Park",
         LU_Type != "Hunting Reserve",
         LU_Type != "Wildlife Reserve",
         TYPE_EN != "Designated Area")
df_missing <- df_missing[,c(1:9)]
####


# create layers for District and Province
district <- shp %>% 
  group_by(DISTRICT) %>% 
  summarise(mean(Sensitivity)) %>% 
  ms_simplify()

province <- shp %>% 
  group_by(STATE_CODE) %>% 
  summarise(mean(Sensitivity)) %>% 
  ms_simplify()


# map it out (red, blue, purple, green)
shp$Index_geo_quint[is.na(shp$Index_geo_quint)] <- 6
shp$Exposure_quint[is.na(shp$Exposure_quint)] <- 6
shp$Sensitivity_quint[is.na(shp$Sensitivity_quint)] <- 6
shp$AdaptiveCapacity_quint[is.na(shp$AdaptiveCapacity_quint)] <- 6



plot_index <- ggplot(shp)+
  geom_sf(aes(fill = factor(Index_geo_quint), size = NA))+
  geom_sf(data = district, aes(fill = NA), lwd = 0.7)+
  geom_sf(data = province, aes(fill = NA), lwd = 1.1)+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "COVID Economic Vulnerability Index",
       fill = "Vulnerability Index")

plot_exposure <- ggplot(shp)+
  geom_sf(aes(fill = factor(Exposure_quint), size = NA))+
  geom_sf(data = district, aes(fill = NA), lwd = 0.7)+
  geom_sf(data = province, aes(fill = NA), lwd = 1.1)+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#feebe2","#fbb4b9", "#f768a1", "#c51b8a", "#7a0177", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Exposure Sub-Index",
       fill = "Exposure")

plot_sensitivity <- ggplot(shp)+
  geom_sf(aes(fill = factor(Sensitivity_quint), size = NA))+
  geom_sf(data = district, aes(fill = NA), lwd = 0.7)+
  geom_sf(data = province, aes(fill = NA), lwd = 1.1)+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#f0f9e8","#bae4bc", "#7bccc4", "#43a2ca", "#0868ac", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Sensitivity Sub-Index",
       fill = "Sensitivity")

plot_adaptcapacity <- ggplot(shp)+
  geom_sf(aes(fill = factor(AdaptiveCapacity_quint), size = NA))+
  geom_sf(data = district, aes(fill = NA), lwd = 0.7)+
  geom_sf(data = province, aes(fill = NA), lwd = 1.1)+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#f7f7f7","#cccccc", "#969696", "#636363", "#252525", "#74c476"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Adaptive Capacity Sub-Index",
       fill = "Adaptive Capacity")



# by-Province results
df_dis_province <- shp %>%
  group_by(STATE_CODE) %>% 
  mutate(index_p = cume_dist(Index_geo),
         exposure_p = cume_dist(Exposure),
         sensitivity_p = cume_dist(Sensitivity),
         AdaptiveCapacity_p = cume_dist(AdaptiveCapacity),
         index_quint_p = ntile(index_p, 5),
         Exposure_quint_p = ntile(exposure_p, 5),
         Sensitivity_quint_p = ntile(sensitivity_p, 5),
         AdaptiveCapacity_quint_p = ntile(AdaptiveCapacity_p, 5)) %>% 
  ungroup()

df_dis_province$index_quint_p[is.na(df_dis_province$index_quint_p)] <- 6



## Province 1
df_prov_p1 <- df_dis_province %>% 
  filter(STATE_CODE == 1)

Prov1 <- df_prov_p1 %>% 
  group_by(DISTRICT) %>% 
  summarise(sum(STATE_CODE)) %>% 
  ms_simplify()

plot_prov_p2 <- ggplot(df_prov_p1)+
  geom_sf(aes(fill = factor(index_quint_p)))+
  geom_sf(data = Prov1, aes(fill = NA), lwd = 1, color = 'black')+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Province 1 COVID Vulnerability Index",
       fill = "Vulnerability Index")


## Province 2
df_prov_p2 <- df_dis_province %>% 
  filter(STATE_CODE == 2)

Prov2 <- df_prov_p2 %>% 
  group_by(DISTRICT) %>% 
  summarise(sum(STATE_CODE)) %>% 
  ms_simplify()

plot_prov_p2 <- ggplot(df_prov_p2)+
  geom_sf(aes(fill = factor(index_quint_p)))+
  geom_sf(data = Prov2, aes(fill = NA), lwd = 1, color = 'black')+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Province 2 COVID Vulnerability Index",
       fill = "COVID Vulnerability Index")


## Bagmati
df_prov_bagmati <- df_dis_province %>% 
  filter(STATE_CODE == 3)

Bagmati <- df_prov_bagmati %>% 
  group_by(DISTRICT) %>% 
  summarise(sum(STATE_CODE)) %>% 
  ms_simplify()

plot_prov_gandaki <- ggplot(df_prov_bagmati)+
  geom_sf(aes(fill = factor(index_quint_p)))+
  geom_sf(data = Bagmati, aes(fill = NA), lwd = 1, color = 'black')+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Bagmati COVID Vulnerability Index",
       fill = "COVID Vulnerability Index")


## Gandaki
df_prov_gandaki <- df_dis_province %>% 
  filter(STATE_CODE == 4)

Gandaki <- df_prov_gandaki %>% 
  group_by(DISTRICT) %>% 
  summarise(sum(STATE_CODE)) %>% 
  ms_simplify()

plot_prov_gandaki <- ggplot(df_prov_gandaki)+
  geom_sf(aes(fill = factor(index_quint_p)))+
  geom_sf(data = Gandaki, aes(fill = NA), lwd = 1, color = 'black')+
  annotation_scale(location = "br", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Gandaki COVID Vulnerability Index",
       fill = "COVID Vulnerability Index")

## Province 5
df_prov_p5 <- df_dis_province %>% 
  filter(STATE_CODE == 5)

Prov5 <- df_prov_p5 %>% 
  group_by(DISTRICT) %>% 
  summarise(sum(STATE_CODE)) %>% 
  ms_simplify()

plot_prov_p5 <- ggplot(df_prov_p5)+
  geom_sf(aes(fill = factor(index_quint_p)))+
  geom_sf(data = Prov5, aes(fill = NA), lwd = 1, color = 'black')+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Province 5 COVID Vulnerability Index",
       fill = "COVID Vulnerability Index")


## Karnali
df_prov_Karnali <- df_dis_province %>% 
  filter(STATE_CODE == 6)

Karnali <- df_prov_Karnali %>% 
  group_by(DISTRICT) %>% 
  summarise(sum(STATE_CODE)) %>% 
  ms_simplify()

plot_prov_karnali <- ggplot(df_prov_Karnali)+
  geom_sf(aes(fill = factor(index_quint_p)))+
  geom_sf(data = Karnali, aes(fill = NA), lwd = 1, color = 'black')+
  annotation_scale(location = "br", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Karnali Province COVID Vulnerability Index",
       fill = "COVID Vulnerability Index")


## Sudurpaschim
df_prov_sudurpaschim <- df_dis_province %>% 
  filter(STATE_CODE == 7)

Sudurpaschim <- df_prov_sudurpaschim %>% 
  group_by(DISTRICT) %>% 
  summarise(sum(STATE_CODE)) %>% 
  ms_simplify()

plot_prov_sudurpaschim <- ggplot(df_prov_sudurpaschim)+
  geom_sf(aes(fill = factor(index_quint_p)))+
  geom_sf(data = Sudurpaschim, aes(fill = NA), lwd = 1, color = 'black')+
  annotation_scale(location = "br", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Sudurpaschim Province COVID Vulnerability Index",
       fill = "COVID Vulnerability Index")



# District-grouped results mapping
df_dist <- shp %>%
  st_drop_geometry() %>% 
  filter(!is.na(Index_geo)) %>% 
  mutate(dist_ind = Index_geo * Population2020,
         dist_exposure = Exposure * Population2020,
         dist_sensitivity = Sensitivity * Population2020,
         dist_adaptivecapacity = AdaptiveCapacity * Population2020) %>% 
  group_by(DISTRICT) %>% 
  summarize(dist_ind = sum(dist_ind) / sum(Population2020),
            dist_exposure = sum(dist_exposure) / sum(Population2020),
            dist_sensitivity = sum(dist_sensitivity) / sum(Population2020),
            dist_adaptivecapacity = sum(dist_adaptivecapacity) / sum(Population2020)) %>% 
  mutate(dist_ind_quint = ntile(dist_ind, 5),
         dist_exposure = ntile(dist_exposure, 5),
         dist_sensitivity = ntile(dist_sensitivity, 5),
         dist_adaptivecapacity = ntile(dist_adaptivecapacity, 5))

glimpse(df_dist)


shp_dist <- merge(shp, df_dist[c("DISTRICT", "dist_ind", "dist_ind_quint", "dist_exposure", "dist_sensitivity", "dist_adaptivecapacity")], all.x = TRUE)

plot_index_dist <- ggplot(shp_dist)+
  geom_sf(aes(fill = factor(dist_ind_quint), size = NA))+
  geom_sf(data = province, aes(fill = NA), lwd = 1.1)+
  geom_sf(data = district, aes(fill = NA), lwd = 0.7)+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#fee8c8","#fdd49e", "#fdbb84", "#ef6548", "#d7301f", "grey70"),
                    
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Districtwise COVID Vulnerability Index",
       fill = "Vulnerability Index")

plot_exposure_dist <- ggplot(shp_dist)+
  geom_sf(aes(fill = factor(dist_exposure), size = NA))+
  geom_sf(data = province, aes(fill = NA), lwd = 1.1)+
  geom_sf(data = district, aes(fill = NA), lwd = 0.7)+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#feebe2","#fbb4b9", "#f768a1", "#c51b8a", "#7a0177", "grey70"),
                    
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Districtwise Exposure Sub-Index",
       fill = "Exposure")

plot_sensitivity_dist <- ggplot(shp_dist)+
  geom_sf(aes(fill = factor(dist_sensitivity), size = NA))+
  geom_sf(data = province, aes(fill = NA), lwd = 1.1)+
  geom_sf(data = district, aes(fill = NA), lwd = 0.7)+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#f0f9e8","#bae4bc", "#7bccc4", "#43a2ca", "#0868ac", "grey70"),
                    
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Districtwise Sensitivity Sub-Index",
       fill = "Sensitivity")

plot_adaptivecapacity_dist <- ggplot(shp_dist)+
  geom_sf(aes(fill = factor(dist_adaptivecapacity), size = NA))+
  geom_sf(data = province, aes(fill = NA), lwd = 1.1)+
  geom_sf(data = district, aes(fill = NA), lwd = 0.7)+
  annotation_scale(location = "bl", width_hint = 0.4)+
  theme_void()+
  scale_fill_manual(values = c("#f7f7f7","#cccccc", "#969696", "#636363", "#252525", "#74c476"),
                    
                    labels = c("Lowest", "Low", "Moderate", "High", "Highest", "N/A"))+
  labs(title = "Districtwise Adaptive Capacity Sub-Index",
       fill = "Adaptive Capacity")
