# sensitivity checks and robustness


require(xlsx)
require(readxl)
require(tidyverse)
require(psych)
require(sf)
require(rmapshaper)
require(factoextra)
require(PerformanceAnalytics)

colname.fun <- function(df, cols){
  vec <- vector()
  for (i in cols){
    vec[i] <- which(colnames(df) == i)
  }
  return(vec)
}





# 1 different way of imputing data: using the national median instead of the District mean

# load data
df <- read_excel("C:/Users/moctar.aboubacar/World Food Programme/SO5- Evidence Policy & Innovation - COVID-19 response/Targeting/Data/1_test_data.xlsx",
                 na = "#N/A")


df$S1.3.most_affected[df$S1.3.most_affected == 0] <- NA
df$S3.2palika_income[df$S3.2palika_income == 0] <- NA

df <- df %>% 
  filter(LU_Type != "National Park",
         LU_Type != "Hunting Reserve",
         LU_Type != "Wildlife Reserve",
         S1.1.Avg_P0WB > 0) %>%
  mutate(S1.3.most_affected = ifelse(is.na(S1.3.most_affected), median(S1.3.most_affected, na.rm = TRUE), S1.3.most_affected),
         S3.2palika_income = ifelse(is.na(S3.2palika_income), median(S3.2palika_income, na.rm = TRUE), S3.2palika_income))


df <- df %>% 
  mutate(S2.1.migrant_india = case_when(S2.1.Migrants_india_pcn < 0.025 ~ 1,
                                        S2.1.Migrants_india_pcn >= 0.025 & S2.1.Migrants_india_pcn < 0.05 ~ 2,
                                        S2.1.Migrants_india_pcn >= 0.05 & S2.1.Migrants_india_pcn < 0.1 ~ 3,
                                        S2.1.Migrants_india_pcn >= 0.1 ~ 4),
         S2.1.migrant_other = case_when(S2.1.Migrants_other_pcn < 0.05 ~ 1,
                                        S2.1.Migrants_other_pcn >= 0.05 & S2.1.Migrants_other_pcn < 0.1 ~ 2,
                                        S2.1.Migrants_other_pcn >= 0.1 & S2.1.Migrants_other_pcn < 0.16 ~ 3,
                                        S2.1.Migrants_other_pcn >= 0.16 & S2.1.Migrants_other_pcn < 0.25 ~ 4,
                                        S2.1.Migrants_other_pcn >= 0.25 ~ 5),
         S1.3.most_affected = (S1.3.most_affected * 5) / Population2020,
         S3.2palika_income = S3.2palika_income / Population2020,
         S3.1.Remoteness = abs(max(S3.1.Remoteness) - S3.1.Remoteness)) # reverse the sign of the Remoteness index so that higher values represent lower remoteness



df_2_robust1 <- df[colname.fun(df, c("GCODE", "HLCIT_CODE", "Population2020", "S1.1.Avg_P0", "S1.1.Avg_K0", "S1.1.Avg_S2", "S1.1.Avg_U2","S1.1.Avg_P0WB","S1.3.dependency_ratio", "S1.2.Avg_W2", "S1.2.Avg_D_1",  "S2.3.pcnvulcaste",  "S2.1.migrant_india", "S2.1.migrant_other", "S1.3.most_affected","S3.2palika_income", "S3.2HDI", "S2.2.exposed_work", "S3.1.Remoteness"))]

df_3_robust1 <- map_df(df_2_robust1[4:19], cume_dist)

df_4_robust1 <- cbind(df_2_robust1[,c(1:3)],df_3_robust1)

df_5_robust1 <- df_4_robust1 %>% 
  mutate(migrants = cume_dist(S2.1.migrant_india + S2.1.migrant_other),
         Exposure = cume_dist(migrants + S2.2.exposed_work + S2.3.pcnvulcaste),
         Pov_foodsec = cume_dist(S1.1.Avg_P0 + S1.1.Avg_P0WB + S1.1.Avg_S2 + S1.1.Avg_K0 + S1.1.Avg_U2 + S1.3.dependency_ratio),
         hygiene_nut = cume_dist(S1.2.Avg_W2 + S1.2.Avg_D_1),
         Sensitivity = cume_dist(Pov_foodsec + hygiene_nut + S1.3.most_affected),
         AdaptiveCapacity = cume_dist(S3.2palika_income + S3.2HDI + S3.1.Remoteness),
         Index_add = cume_dist(Exposure + Sensitivity - AdaptiveCapacity),
         Index_geo = cume_dist((Exposure * 100) * (Sensitivity * 100) / (AdaptiveCapacity * 100)),
         Index_add_quint = ntile(Index_add, 5),
         Index_geo_quint = ntile(Index_geo, 5),
         Exposure_quint = ntile(Exposure, 5),
         Sensitivity_quint = ntile(Sensitivity, 5),
         AdaptiveCapacity_quint = ntile(AdaptiveCapacity, 5))



df_index_robust1 <- df_5_robust1[,colname.fun(df_5_robust1, c("GCODE","HLCIT_CODE", "Exposure", "Sensitivity", "AdaptiveCapacity", "Index_add", "Index_add_quint", "Index_geo", "Index_geo_quint", "Exposure_quint", "Sensitivity_quint", "AdaptiveCapacity_quint", "Population2020"))]

robust_1 <- df_index_robust1$Index_geo_quint




# 2 Separating migration measures in the dimension

# load data
df <- read_excel("C:/Users/moctar.aboubacar/World Food Programme/SO5- Evidence Policy & Innovation - COVID-19 response/Targeting/Data/1_test_data.xlsx",
                 na = "#N/A")



# impute the mean by district
df$S1.3.most_affected[df$S1.3.most_affected == 0] <- NA
df$S3.2palika_income[df$S3.2palika_income == 0] <- NA

df <- df %>% 
  filter(LU_Type != "National Park",
         LU_Type != "Hunting Reserve",
         LU_Type != "Wildlife Reserve",
         S1.1.Avg_P0WB > 0) %>% 
  group_by(DISTRICT) %>% 
  mutate(S1.3.most_affected = ifelse(is.na(S1.3.most_affected), mean(S1.3.most_affected, na.rm = TRUE), S1.3.most_affected),
         S3.2palika_income = ifelse(is.na(S3.2palika_income), mean(S3.2palika_income, na.rm = TRUE), S3.2palika_income)) %>% 
  group_by(STATE) %>% 
  mutate(S3.2palika_income = ifelse(is.na(S3.2palika_income), mean(S3.2palika_income, na.rm = TRUE), S3.2palika_income)) # All Palikas in Dankhuta District are NAs for income, so the mean value of the Province (STATE) is used



df <- df %>% 
  mutate(S2.1.migrant_india = case_when(S2.1.Migrants_india_pcn < 0.025 ~ 1,
                                        S2.1.Migrants_india_pcn >= 0.025 & S2.1.Migrants_india_pcn < 0.05 ~ 2,
                                        S2.1.Migrants_india_pcn >= 0.05 & S2.1.Migrants_india_pcn < 0.1 ~ 3,
                                        S2.1.Migrants_india_pcn >= 0.1 ~ 4),
         S2.1.migrant_other = case_when(S2.1.Migrants_other_pcn < 0.05 ~ 1,
                                        S2.1.Migrants_other_pcn >= 0.05 & S2.1.Migrants_other_pcn < 0.1 ~ 2,
                                        S2.1.Migrants_other_pcn >= 0.1 & S2.1.Migrants_other_pcn < 0.16 ~ 3,
                                        S2.1.Migrants_other_pcn >= 0.16 & S2.1.Migrants_other_pcn < 0.25 ~ 4,
                                        S2.1.Migrants_other_pcn >= 0.25 ~ 5),
         S1.3.most_affected = (S1.3.most_affected * 5) / Population2020,
         S3.2palika_income = S3.2palika_income / Population2020,
         S3.1.Remoteness = abs(max(S3.1.Remoteness) - S3.1.Remoteness)) # reverse the sign of the Remoteness index so that higher values represent lower remoteness



df_2_robust2 <- df[colname.fun(df, c("GCODE", "HLCIT_CODE", "Population2020", "S1.1.Avg_P0", "S1.1.Avg_K0", "S1.1.Avg_S2", "S1.1.Avg_U2","S1.1.Avg_P0WB","S1.3.dependency_ratio", "S1.2.Avg_W2", "S1.2.Avg_D_1",  "S2.3.pcnvulcaste",  "S2.1.migrant_india", "S2.1.migrant_other", "S1.3.most_affected","S3.2palika_income", "S3.2HDI", "S2.2.exposed_work", "S3.1.Remoteness"))]

df_3_robust2 <- map_df(df_2_robust2[4:19], cume_dist)

df_4_robust2 <- cbind(df_2_robust2[,c(1:3)],df_3_robust2)

df_5_robust2 <- df_4_robust2 %>% 
  mutate(Exposure = cume_dist(S2.1.migrant_india + S2.1.migrant_other + S2.2.exposed_work + S2.3.pcnvulcaste),
         Pov_foodsec = cume_dist(S1.1.Avg_P0 + S1.1.Avg_P0WB + S1.1.Avg_S2 + S1.1.Avg_K0 + S1.1.Avg_U2 + S1.3.dependency_ratio),
         hygiene_nut = cume_dist(S1.2.Avg_W2 + S1.2.Avg_D_1),
         Sensitivity = cume_dist(Pov_foodsec + hygiene_nut + S1.3.most_affected),
         AdaptiveCapacity = cume_dist(S3.2palika_income + S3.2HDI + S3.1.Remoteness),
         Index_add = cume_dist(Exposure + Sensitivity - AdaptiveCapacity),
         Index_geo = cume_dist((Exposure * 100) * (Sensitivity * 100) / (AdaptiveCapacity * 100)),
         Index_add_quint = ntile(Index_add, 5),
         Index_geo_quint = ntile(Index_geo, 5),
         Exposure_quint = ntile(Exposure, 5),
         Sensitivity_quint = ntile(Sensitivity, 5),
         AdaptiveCapacity_quint = ntile(AdaptiveCapacity, 5))



df_index_robust2 <- df_5_robust2[,colname.fun(df_5_robust2, c("GCODE","HLCIT_CODE", "Exposure", "Sensitivity", "AdaptiveCapacity", "Index_add", "Index_add_quint", "Index_geo", "Index_geo_quint", "Exposure_quint", "Sensitivity_quint", "AdaptiveCapacity_quint", "Population2020"))]

robust_2 <- df_index_robust2$Index_geo_quint




# 3 a linear variable aggregation scheme

# load data
df <- read_excel("C:/Users/moctar.aboubacar/World Food Programme/SO5- Evidence Policy & Innovation - COVID-19 response/Targeting/Data/1_test_data.xlsx",
                 na = "#N/A")



# impute the mean by district
df$S1.3.most_affected[df$S1.3.most_affected == 0] <- NA
df$S3.2palika_income[df$S3.2palika_income == 0] <- NA

df <- df %>% 
  filter(LU_Type != "National Park",
         LU_Type != "Hunting Reserve",
         LU_Type != "Wildlife Reserve",
         S1.1.Avg_P0WB > 0) %>% 
  group_by(DISTRICT) %>% 
  mutate(S1.3.most_affected = ifelse(is.na(S1.3.most_affected), mean(S1.3.most_affected, na.rm = TRUE), S1.3.most_affected),
         S3.2palika_income = ifelse(is.na(S3.2palika_income), mean(S3.2palika_income, na.rm = TRUE), S3.2palika_income)) %>% 
  group_by(STATE) %>% 
  mutate(S3.2palika_income = ifelse(is.na(S3.2palika_income), mean(S3.2palika_income, na.rm = TRUE), S3.2palika_income)) # All Palikas in Dankhuta District are NAs for income, so the mean value of the Province (STATE) is used



df <- df %>% 
  mutate(S2.1.migrant_india = case_when(S2.1.Migrants_india_pcn < 0.025 ~ 1,
                                        S2.1.Migrants_india_pcn >= 0.025 & S2.1.Migrants_india_pcn < 0.05 ~ 2,
                                        S2.1.Migrants_india_pcn >= 0.05 & S2.1.Migrants_india_pcn < 0.1 ~ 3,
                                        S2.1.Migrants_india_pcn >= 0.1 ~ 4),
         S2.1.migrant_other = case_when(S2.1.Migrants_other_pcn < 0.05 ~ 1,
                                        S2.1.Migrants_other_pcn >= 0.05 & S2.1.Migrants_other_pcn < 0.1 ~ 2,
                                        S2.1.Migrants_other_pcn >= 0.1 & S2.1.Migrants_other_pcn < 0.16 ~ 3,
                                        S2.1.Migrants_other_pcn >= 0.16 & S2.1.Migrants_other_pcn < 0.25 ~ 4,
                                        S2.1.Migrants_other_pcn >= 0.25 ~ 5),
         S1.3.most_affected = (S1.3.most_affected * 5) / Population2020,
         S3.2palika_income = S3.2palika_income / Population2020,
         S3.1.Remoteness = abs(max(S3.1.Remoteness) - S3.1.Remoteness)) # reverse the sign of the Remoteness index so that higher values represent lower remoteness



df_2_robust3 <- df[colname.fun(df, c("GCODE", "HLCIT_CODE", "Population2020", "S1.1.Avg_P0", "S1.1.Avg_K0", "S1.1.Avg_S2", "S1.1.Avg_U2","S1.1.Avg_P0WB","S1.3.dependency_ratio", "S1.2.Avg_W2", "S1.2.Avg_D_1",  "S2.3.pcnvulcaste",  "S2.1.migrant_india", "S2.1.migrant_other", "S1.3.most_affected","S3.2palika_income", "S3.2HDI", "S2.2.exposed_work", "S3.1.Remoteness"))]

df_3_robust3 <- map_df(df_2_robust3[4:19], cume_dist)

df_4_robust3 <- cbind(df_2_robust3[,c(1:3)],df_3_robust3)

df_5_robust3 <- df_4_robust3 %>% 
  mutate(migrants = cume_dist(S2.1.migrant_india + S2.1.migrant_other),
         Exposure = cume_dist(migrants + S2.2.exposed_work + S2.3.pcnvulcaste),
         Pov_foodsec = cume_dist(S1.1.Avg_P0 + S1.1.Avg_P0WB + S1.1.Avg_S2 + S1.1.Avg_K0 + S1.1.Avg_U2 + S1.3.dependency_ratio),
         hygiene_nut = cume_dist(S1.2.Avg_W2 + S1.2.Avg_D_1),
         Sensitivity = cume_dist(Pov_foodsec + hygiene_nut + S1.3.most_affected),
         AdaptiveCapacity = cume_dist(S3.2palika_income + S3.2HDI + S3.1.Remoteness),
         Index_add = cume_dist(Exposure + Sensitivity - AdaptiveCapacity),
         Index_geo = cume_dist((Exposure * 100) * (Sensitivity * 100) / (AdaptiveCapacity * 100)),
         Index_add_quint = ntile(Index_add, 5),
         Index_geo_quint = ntile(Index_geo, 5),
         Exposure_quint = ntile(Exposure, 5),
         Sensitivity_quint = ntile(Sensitivity, 5),
         AdaptiveCapacity_quint = ntile(AdaptiveCapacity, 5))



df_index_robust3 <- df_5_robust3[,colname.fun(df_5_robust3, c("GCODE","HLCIT_CODE", "Exposure", "Sensitivity", "AdaptiveCapacity", "Index_add", "Index_add_quint", "Index_geo", "Index_geo_quint", "Exposure_quint", "Sensitivity_quint", "AdaptiveCapacity_quint", "Population2020"))]

robust_3 <- df_index_robust3$Index_add_quint
robust_3_cont <- df_index_robust3$Index_add




# 4 Equal weights to all variables regardless

# load data
df <- read_excel("C:/Users/moctar.aboubacar/World Food Programme/SO5- Evidence Policy & Innovation - COVID-19 response/Targeting/Data/1_test_data.xlsx",
                 na = "#N/A")



# impute the mean by district
df$S1.3.most_affected[df$S1.3.most_affected == 0] <- NA
df$S3.2palika_income[df$S3.2palika_income == 0] <- NA

df <- df %>% 
  filter(LU_Type != "National Park",
         LU_Type != "Hunting Reserve",
         LU_Type != "Wildlife Reserve",
         S1.1.Avg_P0WB > 0) %>% 
  group_by(DISTRICT) %>% 
  mutate(S1.3.most_affected = ifelse(is.na(S1.3.most_affected), mean(S1.3.most_affected, na.rm = TRUE), S1.3.most_affected),
         S3.2palika_income = ifelse(is.na(S3.2palika_income), mean(S3.2palika_income, na.rm = TRUE), S3.2palika_income)) %>% 
  group_by(STATE) %>% 
  mutate(S3.2palika_income = ifelse(is.na(S3.2palika_income), mean(S3.2palika_income, na.rm = TRUE), S3.2palika_income)) # All Palikas in Dankhuta District are NAs for income, so the mean value of the Province (STATE) is used



df <- df %>% 
  mutate(S2.1.migrant_india = case_when(S2.1.Migrants_india_pcn < 0.025 ~ 1,
                                        S2.1.Migrants_india_pcn >= 0.025 & S2.1.Migrants_india_pcn < 0.05 ~ 2,
                                        S2.1.Migrants_india_pcn >= 0.05 & S2.1.Migrants_india_pcn < 0.1 ~ 3,
                                        S2.1.Migrants_india_pcn >= 0.1 ~ 4),
         S2.1.migrant_other = case_when(S2.1.Migrants_other_pcn < 0.05 ~ 1,
                                        S2.1.Migrants_other_pcn >= 0.05 & S2.1.Migrants_other_pcn < 0.1 ~ 2,
                                        S2.1.Migrants_other_pcn >= 0.1 & S2.1.Migrants_other_pcn < 0.16 ~ 3,
                                        S2.1.Migrants_other_pcn >= 0.16 & S2.1.Migrants_other_pcn < 0.25 ~ 4,
                                        S2.1.Migrants_other_pcn >= 0.25 ~ 5),
         S1.3.most_affected = (S1.3.most_affected * 5) / Population2020,
         S3.2palika_income = S3.2palika_income / Population2020,
         S3.1.Remoteness = abs(max(S3.1.Remoteness) - S3.1.Remoteness)) # reverse the sign of the Remoteness index so that higher values represent lower remoteness



df_2_robust4 <- df[colname.fun(df, c("GCODE", "HLCIT_CODE", "Population2020", "S1.1.Avg_P0", "S1.1.Avg_K0", "S1.1.Avg_S2", "S1.1.Avg_U2","S1.1.Avg_P0WB","S1.3.dependency_ratio", "S1.2.Avg_W2", "S1.2.Avg_D_1",  "S2.3.pcnvulcaste",  "S2.1.migrant_india", "S2.1.migrant_other", "S1.3.most_affected","S3.2palika_income", "S3.2HDI", "S2.2.exposed_work", "S3.1.Remoteness"))]

df_3_robust4 <- map_df(df_2_robust4[4:19], cume_dist)

df_4_robust4 <- cbind(df_2_robust4[,c(1:3)],df_3_robust4)

df_5_robust4 <- df_4_robust4 %>% 
  mutate(migrants = cume_dist((S2.1.migrant_india * 1/16) + (S2.1.migrant_other * 1/16)),
         Exposure = cume_dist(migrants + (S2.2.exposed_work* 1/16) + (S2.3.pcnvulcaste* 1/16)),
         Pov_foodsec = cume_dist((S1.1.Avg_P0 * 1/16) + (S1.1.Avg_P0WB* 1/16) + (S1.1.Avg_S2 * 1/16) + (S1.1.Avg_K0* 1/16) + (S1.1.Avg_U2* 1/16) + (S1.3.dependency_ratio* 1/16)),
         hygiene_nut = cume_dist((S1.2.Avg_W2* 1/16) + (S1.2.Avg_D_1* 1/16)),
         Sensitivity = cume_dist(Pov_foodsec + hygiene_nut + (S1.3.most_affected* 1/16)),
         AdaptiveCapacity = cume_dist((S3.2palika_income * 1/16) + (S3.2HDI* 1/16) + (S3.1.Remoteness* 1/16)),
         Index_geo = cume_dist((Exposure * 100) * (Sensitivity * 100) / (AdaptiveCapacity * 100)),
         Index_geo_quint = ntile(Index_geo, 5),
         Exposure_quint = ntile(Exposure, 5),
         Sensitivity_quint = ntile(Sensitivity, 5),
         AdaptiveCapacity_quint = ntile(AdaptiveCapacity, 5))



df_index_robust4 <- df_5_robust4[,colname.fun(df_5_robust4, c("GCODE","HLCIT_CODE", "Exposure", "Sensitivity", "AdaptiveCapacity", "Index_geo", "Index_geo_quint", "Exposure_quint", "Sensitivity_quint", "AdaptiveCapacity_quint", "Population2020"))]

robust_4 <- df_index_robust4$Index_geo_quint
robust_4_cont <- df_index_robust4$Index_geo



# the comparison
robust_baseline <- df_index$Index_geo_quint

# Comparison tables show that there are no radical changes of category--all changes are within 1 quintile category
comparison_1 <- table(robust_baseline, robust_1)
comparison_2 <- table(robust_baseline, robust_2)
comparison_3 <- table(robust_baseline, robust_3)
comparison_4 <- table(robust_baseline, robust_4)

# Accuracy measures (here, how much there is overlap in the two methods)
sum(diag(comparison_1)/sum(comparison_1))
sum(diag(comparison_2)/sum(comparison_2))
sum(diag(comparison_3)/sum(comparison_3))
sum(diag(comparison_4)/sum(comparison_4))

# graph out comparison 3
comp_3_df <- as.data.frame(cbind(robust_3_cont, index =  df_index$Index_geo, STATE = df_index$STATE))

comp_3_df <- as.data.frame(apply(comp_3_df, 2, as.double))

nominal <- c("#7fc97f", "#beaed4", "#fdc086","#ffff99", "#386cb0", "#f0027f", "#bf5b17")

plot_2 <- ggplot(comp_3_df, aes(x = index, y = robust_3_cont, color = factor(STATE)))+
  geom_point(size = 1.5, alpha = 0.6)+
  geom_smooth(method = 'lm', se = F)+
  scale_color_brewer(type = 'qual', palette = 'Set2', direction = 1)+
  labs(title = "Sensitivity Check 2",
       x = "Adopted Vulnerability Index",
       y = "Linear Aggregation Measure",
       color = "Province")
  


# CONCLUSION: (1) we can see here that Provinces 6 and 7 are the ones mainly affected. This is where there are the most changes in category.
# CONCLUSION (2) the variation is most apparent on the tails of the distribution.

# graph out comparison 4
comp_4_df <- as.data.frame(cbind(robust_4_cont, index =  df_index$Index_geo, STATE = df_index$STATE))

comp_4_df <- as.data.frame(apply(comp_4_df, 2, as.double))

plot_1 <- ggplot(comp_4_df, aes(x = index, y = robust_4_cont, color = factor(STATE)))+
  geom_point(size = 1.5, alpha = 0.6)+
  geom_smooth(method = 'lm', se = F)+
  scale_color_brewer(type = 'qual', palette = 'Set2', direction = 1)+
  labs(title = "Sensitivity Check 1",
       x = "Adopted Vulnerability Index",
       y = "Equal Weighting Measure",
       color = "Province")

# CONCLUSION: Comparison 4  results in many more changes-- overlap of only 50% in the quintiles. Scores are consistently higher for Province 7 and 5, lower for 3 and 1. HOwever the basic relationship between provinces does not change on the whole





